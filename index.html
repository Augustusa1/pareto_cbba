<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis de Costos y Proyección</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .bg-brand-red { background-color: #991b1b; }
        .text-brand-red { color: #991b1b; }
        .border-brand-red { border-color: #991b1b; }
        .hover\:bg-brand-red-dark:hover { background-color: #7f1d1d; }
        #chartModal {
            display: none; /* Hidden by default */
        }
        .kpi-card {
            background-color: #fef2f2;
            border-left: 5px solid #b91c1c;
            transition: all 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="bg-red-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-brand-red">Análisis Comparativo de Costos Almacenaje CBBA</h1>
            <p class="text-gray-600 mt-2">G.2024-2025 vs. Proyección G.2025-2026</p>
        </header>

        <!-- Sección de KPIs -->
        <section class="mb-12">
             <h2 class="text-2xl font-semibold text-brand-red mb-6 text-center">Costo Unitario (BS/KG)</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- KPIs Pasados -->
                <div class="kpi-card p-4 rounded-lg shadow-md text-center">
                    <p class="text-gray-500 text-sm font-medium">G.22-23</p>
                    <p class="text-3xl font-bold text-gray-800 my-1">0.45</p>
                    <p class="text-xs text-green-600 font-semibold flex items-center justify-center">
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                        Cumplido
                    </p>
                    <p class="text-xs text-gray-500">Obj: 0.46</p>
                </div>
                 <div class="kpi-card p-4 rounded-lg shadow-md text-center">
                    <p class="text-gray-500 text-sm font-medium">G.23-24</p>
                    <p class="text-3xl font-bold text-gray-800 my-1">0.40</p>
                    <p class="text-xs text-green-600 font-semibold flex items-center justify-center">
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                        Cumplido
                    </p>
                    <p class="text-xs text-gray-500">Obj: 0.45</p>
                </div>
                <!-- KPI Actual -->
                 <div class="kpi-card p-4 rounded-lg shadow-md text-center">
                    <p class="text-gray-600 text-sm font-medium">(G.24-25)</p>
                    <p class="text-3xl font-bold text-gray-800 my-1">0.43</p>
                    <p class="text-xs text-green-600 font-semibold flex items-center justify-center">
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                        Cumplido
                    </p>
                    <p class="text-xs text-gray-500">Obj: 0.43</p>
                </div>
                <!-- KPI Propuesto -->
                 <div class="kpi-card p-4 rounded-lg shadow-md text-center bg-green-100 border-l-green-700">
                    <p class="text-gray-600 text-sm font-medium">OBJETIVO PROPUESTO</p>
                    <p class="text-3xl font-bold text-green-800 my-1">0.71</p>
                    <p class="text-xs text-gray-500">G.2025-2026</p>
                </div>
            </div>
        </section>
        
        <!-- Pareto de Costos 24-25 -->
        <section class="bg-white p-6 rounded-lg shadow-md mt-8 mb-8">
            <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                <div>
                    <h2 class="text-2xl font-semibold text-brand-red">Pareto de Costos G.2024-2025</h2>
                    <p class="text-sm text-gray-500">Composición de los costos de la gestión actual.</p>
                </div>
                <button data-chart-type="cost" class="expandChartBtn bg-brand-red text-white px-4 py-2 rounded-lg hover:bg-brand-red-dark transition-colors">Ampliar Gráfico</button>
            </div>
            <div class="h-96">
                 <canvas id="costParetoChart"></canvas>
            </div>
        </section>

        <!-- Pareto de Variaciones -->
        <section class="bg-white p-6 rounded-lg shadow-md mt-8 mb-8">
            <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                <div>
                    <h2 class="text-2xl font-semibold text-brand-red">Pareto de Variaciones (Nominal y Porcentual)</h2>
                    <p class="text-sm text-gray-500">Identifica las cuentas con mayor impacto en el cambio de costos.</p>
                </div>
                <button data-chart-type="variation" class="expandChartBtn bg-brand-red text-white px-4 py-2 rounded-lg hover:bg-brand-red-dark transition-colors">Ampliar Gráfico</button>
            </div>
            <div class="h-96">
                 <canvas id="variationParetoChart"></canvas>
            </div>
        </section>

        <!-- Sección de Premisas -->
        <section class="bg-white p-6 rounded-lg shadow-md mt-8">
            <h2 class="text-2xl font-semibold text-brand-red mb-4">Premisas de Incremento en el Pareto</h2>
            <ul class="list-disc list-inside text-gray-700 space-y-3 pl-2">
                <li><strong>Depreciacion del CD-ESMERALDA:</strong> 353.450</li>
                <li><strong>Mantenimiento Interno:</strong> Incorporación de 5 nuevos técnicos.</li>
                <li><strong>Energia electrica y Agua:</strong> Incremento por el Nuevo CD-ESMERALDA.</li>
                <li><strong>Conectividad y comunicaciones:</strong> Las nuevas conexiones de red en el NCD (Enlace de datos). Las actuales se reducen a la mitad.</li>
            </ul>
        </section>
    </div>

    <!-- Modal para el Gráfico Ampliado -->
    <div id="chartModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-6xl h-full max-h-[90vh] relative flex flex-col">
            <div class="flex justify-between items-center mb-4">
                 <h3 id="modalTitle" class="text-2xl font-semibold text-brand-red">Gráfico Ampliado</h3>
                 <button id="closeModalBtn" class="text-gray-600 hover:text-gray-900 text-3xl font-bold">&times;</button>
            </div>
            <div class="flex-grow h-full">
                <canvas id="modalChartCanvas"></canvas>
            </div>
        </div>
    </div>


    <script>
        const costData = [
            { category: 'MANO DE OBRA', account: 'Sueldos Y Jornales', value: 191071, projected_value: 217821 },
            { category: 'MANO DE OBRA', account: 'Beneficios Sociales', value: 144213, projected_value: 164403 },
            { category: 'MANO DE OBRA', account: 'Gastos De Alimentacion', value: 17279, projected_value: 19871 },
            { category: 'MANO DE OBRA', account: 'Horas Extras', value: 18920, projected_value: 21190 },
            { category: 'MANO DE OBRA', account: 'Ropa De Trabajo', value: 12804, projected_value: 17925 },
            { category: 'MANO DE OBRA', account: 'Gastos Medicos Y Capacitacion', value: 6395, projected_value: 6715 },
            { category: 'Costos Fijos', account: 'Depreciacion', value: 63061, projected_value: 416511 },
            { category: 'Costos Fijos', account: 'Desgaste de Canastilla', value: 16385, projected_value: 16385 },
            { category: 'Costos Fijos', account: 'Cconectividad y comunicaciones', value: 2253, projected_value: 5315 },
            { category: 'Costos Fijos', account: 'Gastos legales y tributarios', value: 3557, projected_value: 7113 },
            { category: 'Costos Fijos', account: 'Sistemas tecnologicos', value: 2160, projected_value: 2160 },
            { category: 'Costos Fijos', account: 'Servicios Externos', value: 8368, projected_value: 9204 },
            { category: 'Costos Fijos', account: 'Gastos Generales', value: 22360, projected_value: 41105 },
            { category: 'Costos Fijos', account: 'Seguros Gral, Fletes De Producto', value: 638, projected_value: 638 },
            { category: 'Costos Fijos', account: 'Pasajes Y Viaticos', value: 3130, projected_value: 3130 },
            { category: 'Costos variables', account: 'Material Y Prod.Limpieza', value: 8877, projected_value: 11540 },
            { category: 'Costos variables', account: 'Energia Electrica Y Agua', value: 40938, projected_value: 109741 },
            { category: 'Costos variables', account: 'Mantenimiento Y Repuestos', value: 22321, projected_value: 35714 },
            { category: 'Costos variables', account: 'Materiales Escritorio Y Suministros', value: 11519, projected_value: 14975 },
            { category: 'Costos variables', account: 'Baja De Productos', value: 7105, projected_value: 7105 },
            { category: 'Costos variables', account: 'Envases', value: 9868, projected_value: 11842 },
            { category: 'Costos variables', account: 'Consumo De Hielo', value: 276, projected_value: 276 },
            { category: 'Costos variables', account: 'Costo de Servicios Internos', value: 58998, projected_value: 66078 },
            { category: 'Costos variables', account: 'Costo de servicio de areas de soporte', value: 38427, projected_value: 46113 },
            { category: 'Costos variables', account: 'Mantenimiento Interno', value: 8632, projected_value: 48632 },
            { category: 'Costos variables', account: 'Costos Lav. Y Ctrol de Canastillas', value: 32521, projected_value: 37073 },
            { category: 'Costos variables', account: 'Costo Almacenaje Mat. Y Sum.', value: 17809, projected_value: 19946 },
        ];

        let modalChartInstance = null; 

        // --- Gráfico Pareto de Costos 24-25 ---
        function createCostParetoChart(canvasId) {
            const sortedData = [...costData].sort((a, b) => b.value - a.value);
            const labels = sortedData.map(item => item.account);
            const dataValues = sortedData.map(item => item.value);
            const totalCost = dataValues.reduce((sum, value) => sum + value, 0);

            let cumulativePercentage = 0;
            const paretoData = dataValues.map(value => {
                cumulativePercentage += (value / totalCost) * 100;
                return cumulativePercentage;
            });

            const ctx = document.getElementById(canvasId).getContext('2d');
            return new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Costo (Bs)',
                        data: dataValues,
                        backgroundColor: 'rgba(153, 27, 27, 0.6)',
                        yAxisID: 'y',
                    }, {
                        label: 'Acumulado',
                        data: paretoData,
                        type: 'line',
                        borderColor: 'rgba(220, 38, 38, 1)',
                        yAxisID: 'y1',
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { autoSkip: false, maxRotation: 90, minRotation: 90, font: { size: 10 } } },
                        y: { type: 'linear', position: 'left', title: { display: true, text: 'Costo (Bs)' } },
                        y1: { type: 'linear', position: 'right', min: 0, max: 100, title: { display: true, text: 'Acumulado (%)' }, grid: { drawOnChartArea: false }, ticks: { callback: value => value.toFixed(0) + '%' } }
                    },
                    plugins: { tooltip: { callbacks: { label: context => `${context.dataset.label}: ${context.dataset.yAxisID === 'y1' ? context.parsed.y.toFixed(2) + '%' : context.parsed.y.toLocaleString('es-BO')}` } } }
                }
            });
        }

        // --- Gráfico Pareto de Variaciones ---
        function createVariationParetoChart(canvasId) {
            const variationsData = costData.map(item => {
                const nominalVariation = item.projected_value - item.value;
                const percentageVariation = item.value !== 0 ? (nominalVariation / item.value) * 100 : 0;
                return { account: item.account, nominalVariation, percentageVariation };
            }).filter(item => item.nominalVariation > 0);

            variationsData.sort((a, b) => b.percentageVariation - a.percentageVariation);

            const labels = variationsData.map(item => item.account);
            const nominalValues = variationsData.map(item => item.nominalVariation);
            const percentageValues = variationsData.map(item => item.percentageVariation);
            
            const totalNominalVariation = nominalValues.reduce((sum, value) => sum + value, 0);

            let cumulativePercentage = 0;
            const paretoData = nominalValues.map(value => {
                cumulativePercentage += (value / totalNominalVariation) * 100;
                return cumulativePercentage;
            });

            const ctx = document.getElementById(canvasId).getContext('2d');
            return new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Variación (%)',
                        data: percentageValues,
                        backgroundColor: 'rgba(153, 27, 27, 0.6)',
                        yAxisID: 'y',
                    }, {
                        label: 'Acumulado',
                        data: paretoData,
                        type: 'line',
                        borderColor: 'rgba(220, 38, 38, 1)',
                        yAxisID: 'y1',
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { autoSkip: false, maxRotation: 90, minRotation: 90, font: { size: 10 } } },
                        y: { type: 'linear', position: 'left', title: { display: true, text: 'Variación Individual (%)' }, ticks: { callback: value => value.toFixed(0) + '%' } },
                        y1: { type: 'linear', position: 'right', min: 0, max: 100, title: { display: true, text: 'Acumulado del Impacto Total (%)' }, grid: { drawOnChartArea: false }, ticks: { callback: value => value.toFixed(0) + '%' } }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: context => {
                                    if (context.dataset.yAxisID === 'y1') {
                                        return `Acumulado: ${context.parsed.y.toFixed(2)}%`;
                                    }
                                    const index = context.dataIndex;
                                    const percentage = percentageValues[index].toFixed(2);
                                    const nominal = nominalValues[index].toLocaleString('es-BO');
                                    return `Var. %: ${percentage}% (Var. Bs: ${nominal})`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Crear gráficos iniciales
        createCostParetoChart('costParetoChart');
        createVariationParetoChart('variationParetoChart');

        // --- Lógica del Modal ---
        const modal = document.getElementById('chartModal');
        const modalTitle = document.getElementById('modalTitle');
        const closeModalBtn = document.getElementById('closeModalBtn');

        document.querySelectorAll('.expandChartBtn').forEach(button => {
            button.addEventListener('click', (event) => {
                const chartType = event.currentTarget.getAttribute('data-chart-type');
                
                if (modalChartInstance) {
                    modalChartInstance.destroy();
                }

                if (chartType === 'cost') {
                    modalTitle.textContent = 'Pareto de Costos G.2024-2025 (Ampliado)';
                    modalChartInstance = createCostParetoChart('modalChartCanvas');
                } else if (chartType === 'variation') {
                    modalTitle.textContent = 'Pareto de Variaciones (Ampliado)';
                    modalChartInstance = createVariationParetoChart('modalChartCanvas');
                }
                
                modal.style.display = 'flex';
            });
        });

        const closeModal = () => {
            modal.style.display = 'none';
        };

        closeModalBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal();
            }
        });

    </script>
</body>
</html>
